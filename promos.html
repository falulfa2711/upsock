<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Up סטוק | אבחון מערכת</title>
    <style>
        body { font-family: sans-serif; direction: rtl; padding: 20px; background: #f0f0f0; }
        .debug-box { background: #fff; border: 2px solid #ed1c24; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .promo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .promo-card { background: #fff; border: 1px solid #ccc; padding: 10px; text-align: center; border-radius: 8px; }
        .badge { background: #ffcc00; padding: 5px; font-weight: bold; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="debug-box" id="debug-log">
        <h3>סטטוס טעינה:</h3>
        <p id="p-status">טוען קובץ מבצעים...</p>
        <p id="s-status">טוען קובץ מלאי...</p>
    </div>

    <div id="promo-container" class="promo-grid"></div>

<script>
function toFullBarcode(val) {
    if (!val) return "";
    let s = val.toString().replace(/"/g, '').trim();
    if (s.toLowerCase().includes('e+')) {
        // המרה של מספר מדעי למספר רגיל
        return Number(s).toLocaleString('fullwide', {useGrouping:false});
    }
    return s.replace(/\D/g, '');
}

async function loadDeals() {
    const pStatus = document.getElementById('p-status');
    const sStatus = document.getElementById('s-status');
    const container = document.getElementById('promo-container');

    try {
        // 1. טעינת מבצעים
        const pRes = await fetch('stock_promos.csv?t=' + Date.now());
        const pText = await pRes.text();
        const pRows = pText.split(/\r?\n/);
        let promos = {};
        
        pRows.forEach(row => {
            const parts = row.split(',');
            if (parts.length >= 2) {
                const bc = toFullBarcode(parts[0]);
                if(bc && bc !== "barcode") promos[bc] = parts[1].trim();
            }
        });
        
        const pCount = Object.keys(promos).length;
        pStatus.innerHTML = `✅ קובץ מבצעים נטען. נמצאו ${pCount} ברקודים למבצע.`;

        // 2. טעינת מלאי
        const sRes = await fetch('stock.csv?t=' + Date.now());
        const sText = await sRes.text();
        const sRows = sText.split(/\r?\n/);
        sStatus.innerHTML = `✅ קובץ מלאי נטען. סורק ${sRows.length} שורות...`;

        let foundAny = false;

        sRows.forEach((row, idx) => {
            if (idx === 0) return;
            
            // אנחנו בודקים כל מילה בשורה כדי לראות אם היא ברקוד מוכר
            const words = row.split(/[;,]/);
            words.forEach((word, colIdx) => {
                const cleanWord = toFullBarcode(word);
                
                if (cleanWord && promos[cleanWord]) {
                    foundAny = true;
                    // אם מצאנו ברקוד, ננסה לקחת את השם והמחיר מהעמודות הקרובות
                    const name = words[2] || "מוצר";
                    const price = words[6] || "0";

                    container.innerHTML += `
                        <div class="promo-card">
                            <span class="badge">${promos[cleanWord]}</span>
                            <strong>${name.replace(/"/g, '')}</strong><br>
                            <span>₪${price.replace(/"/g, '')}</span>
                        </div>`;
                }
            });
        });

        if (!foundAny) {
            sStatus.innerHTML += `<br>❌ לא נמצאה אף התאמה בין הברקודים במבצעים לבין המלאי.`;
            sStatus.style.color = "red";
        }

    } catch (e) {
        pStatus.innerHTML = "❌ שגיאה: ודא שהקבצים קיימים ב-GitHub באותה תיקייה.";
        console.error(e);
    }
}

window.onload = loadDeals;
</script>
</body>
</html>
